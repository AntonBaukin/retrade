<?xml version = '1.0' encoding = 'UTF-8'?>

<ui:fragment xmlns = 'http://www.w3.org/1999/xhtml'
   xmlns:ui = 'http://java.sun.com/jsf/facelets'
   xmlns:co = 'http://java.sun.com/jsf/composite'
   xmlns:z  = 'uri:tverts.com'>

  <co:interface>

    <co:attribute name = 'coid' required = 'true'
       type = 'java.lang.String'/>

    <co:attribute name = 'domainOwner' default = 'true'
       type = 'java.lang.Boolean'/>

    <co:attribute name = 'winmainName' default = 'winmain'
       type = 'java.lang.String'/>

    <co:facet name = 'extjs-props'/>
    <co:facet name = 'toolbar-props'/>
    <co:facet name = 'toolbar'/>
    <co:facet name = 'status-props'/>
    <co:facet name = 'status'/>

  </co:interface>

  <co:implementation>

    <div id = "#{cc.clientId}-#{cc.attrs.coid}-props" style = "display:none">
      <co:renderFacet name = "extjs-props"/>
    </div>

    <div id = "#{cc.clientId}-#{cc.attrs.coid}-toolbar-props" style = "display:none">
      <co:renderFacet name = "toolbar-props"/>
    </div>

    <div id = "#{cc.clientId}-#{cc.attrs.coid}-status-props" style = "display:none">
      <co:renderFacet name = "status-props"/>
    </div>

    <script type = "text/javascript">

  (function()
  {
    var domain  = '${rootView.extjsDomain}';
    var winmain = extjsf.bind('#{cc.attrs.winmainName}', domain);
    if(!winmain || !winmain.component())
      throw 'No window [#{cc.attrs.winmainName}] found in the domain ' +
        '[${rootView.extjsDomain}]!'

    //~: add domain destructor (on the window close)
    if('#{cc.attrs.domainOwner}' == 'true')
    {
      //~: create and attach remove listener
      if(!winmain._domain_deleter)
        winmain._domain_deleter = extjsf.domainDeleter('${rootView.extjsDomain}')
      winmain.on('beforedestroy', winmain._domain_deleter)

      //~: register this bind by the global name
      extjsf.defineBind('domain-owner', domain, winmain)
    }

    //~: create the root panel
    var panel = extjsf.defineBind('#{cc.attrs.coid}', domain);
    panel.nodeId("#{cc.clientId}-#{cc.attrs.coid}")

    //~: configure it
    panel.extjsProps({

      xtype: 'panel',
      layout: 'border', region: 'center',
      border: false, preventHeader: true,
      frame: false, shadow: false,
      bodyPadding: extjsf.pt(1)

    })

    panel.extjsPropsNode()

    //~: create the toolbar
    var toolbar = extjsf.defineBind('#{cc.attrs.coid}-toolbar', domain);
    toolbar.nodeId("#{cc.clientId}-#{cc.attrs.coid}-toolbar")
    toolbar.extjsProps({xtype: 'toolbar', dock: 'top'}).extjsPropsNode()

    //~: create the status bar
    var status = extjsf.defineBind('#{cc.attrs.coid}-status', domain);
    status.nodeId("#{cc.clientId}-#{cc.attrs.coid}-status")
    status.extjsProps({xtype: 'statusbar', dock: 'bottom'}).extjsPropsNode()
  })()

    </script>


    <!-- [insert toolbar controls -->

    <co:renderFacet name = "toolbar"/>

    <script type = "text/javascript">

  (function()
  {
    var domain  = '${rootView.extjsDomain}';
    var panel   = extjsf.bind("#{cc.attrs.coid}", domain);
    var toolbar = extjsf.bind('#{cc.attrs.coid}-toolbar', domain);

    //HINT: we steal the items from the winmain panel
    //  and add them to the toolbar!

    toolbar.replaceItems(panel.replaceItems())

  })()

    </script>

    <!-- insert toolbar controls] -->


    <!-- [insert status bar controls -->

    <co:renderFacet name = "status"/>

    <script type = "text/javascript">

  (function()
  {
    var domain = '${rootView.extjsDomain}';
    var panel  = extjsf.bind("#{cc.attrs.coid}", domain);
    var status = extjsf.bind('#{cc.attrs.coid}-status', domain);

    //HINT: we steal the items from the winmain panel
    //  and add them to the status bar (the same as for the toolbar)!

    status.replaceItems(panel.replaceItems())

  })()

    </script>

    <!-- insert status bar controls] -->


    <co:insertChildren/>

    <script type = "text/javascript">

  (function()
  {
    var domain  = '${rootView.extjsDomain}';
    var winmain = extjsf.bind('#{cc.attrs.winmainName}', domain);
    if(!winmain || !winmain.component()) return;

    var panel   = extjsf.bind("#{cc.attrs.coid}", domain);
    var toolbar = extjsf.bind('#{cc.attrs.coid}-toolbar', domain);
    var status  = extjsf.bind('#{cc.attrs.coid}-status', domain);

    //?: {toolbar has items} add it to the window
    if(toolbar.hasItems() || toolbar.hasHTML())
      winmain.component().addDocked(toolbar.extjsProps())

    //?: {status bar has items} add it to the window
    if(status.hasItems() || status.hasHTML())
      winmain.component().addDocked(status.extjsProps())

    //!: add the panel to the window
    winmain.component().add(panel.extjsProps())

  })()

    </script>

  </co:implementation>
</ui:fragment>