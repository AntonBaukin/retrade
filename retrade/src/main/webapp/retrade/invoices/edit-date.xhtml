<ui:component xmlns:ui = 'http://java.sun.com/jsf/facelets'
  xmlns:c  = 'http://java.sun.com/jsp/jstl/core'
  xmlns:f  = 'http://java.sun.com/jsf/core'
  xmlns:z  = 'uri:tverts.com'>

<c:set var = "e" scope = "request" value = "${facesInvoiceEditDate}"/>

<ui:decorate template = '/resources/.view-modes/body.xhtml'
   xmlns    = 'http://www.w3.org/1999/xhtml'
   xmlns:h  = 'http://java.sun.com/jsf/html'
   xmlns:x  = 'http://java.sun.com/jsf/composite/.xhtml'>

<ui:define name = 'page_body'>

<x:winmain coid = "${z:vid(e, 'root_panel')}">

  <script type = "text/javascript">

    extjsf.bind('winmain', '${rootView.extjsDomain}').
      component().setTitle('${z:jss(e.winmainTitleEditDate)}')

  </script>

  <f:facet name = "toolbar-props">
    xtype: 'panel', bodyPadding: extjsf.pt(2),
    layout: {type: 'hbox', align: 'middle'},
    bodyCls: 'retrade-toolbar-panel'
  </f:facet>

  <f:facet name = "toolbar">

    <!-- [cancel edit button] -->

    <x:winaction-button coid = "${z:vid(e, 'cancel-edit')}"
      action = "#{e.gotoCancelEdit}">

      <f:facet name = "extjs-props">
        cls: 'ux-btn-default-small-red',
        text: 'Отмена'
      </f:facet>

      <f:facet name = "action-params">
        '${e.modelParam}': '#{e.modelKeys}'
      </f:facet>
    </x:winaction-button>


    <x:component coid = "${z:vid(e, '_tb_fill_0')}">
      <f:facet name = "extjs-props">
        xtype: 'panel', flex: 1, frame: false, border: false,
        bodyCls: 'retrade-toolbar-panel'
      </f:facet>
    </x:component>


    <!-- [submit button] -->

    <x:component coid = "${z:vid(e, 'submit')}">
      <f:facet name = "extjs-props">
        xtype:'button', text: 'Применить',
        cls: 'ux-btn-default-small-green'
      </f:facet>
    </x:component>

  </f:facet>


  <!-- [invoice date edit form -->

  <x:form-panel modelView = "${e}" coid = "${z:vid(e, 'invoice-date-form')}">

    <f:facet name = "extjs-props">

      region: 'north', frame: true,
      margin: extjsf.pts(1, 1, 0, 1),
      bodyPadding: extjsf.pts(2, 0, 2, 0),
      layout: {type: 'hbox', align: 'middle'}

    </f:facet>


    <!-- [invoice date field -->

    <x:date-field coid = "${z:vid(e, 'date')}" value = "#{e.invoiceDatePart}">
      <f:facet name = "extjs-props">
        margin: extjsf.dpts(0, 2, 0, 2),

        listeners : { change: { delay: 1000, fn: function() {
          extjsf.bindHandler("${z:vid(e, 'date')}", '${rootView.extjsDomain}')()
        }}}
      </f:facet>

      <f:facet name = "label-props">
        text: 'Дата', cls: 'retrade-info-title-label'
      </f:facet>
    </x:date-field>

    <!-- invoice date field] -->


    <!-- [invoice time field -->

    <x:time-field coid = "${z:vid(e, 'time')}" value = "#{e.invoiceTimePart}">
      <f:facet name = "extjs-props">
        margin: extjsf.dpts(0, 2, 0, 2),

        listeners : { change: { delay: 1000, fn: function() {
          extjsf.bindHandler("${z:vid(e, 'date')}", '${rootView.extjsDomain}')()
        }}}
      </f:facet>

      <f:facet name = "label-props">
        text: 'время', cls: 'retrade-info-title-label'
      </f:facet>
    </x:time-field>

    <!-- invoice time field] -->

    <!-- [submit action] -->

    <h:commandButton id = "submit_action" value = "submit" style = "display: none;"
      action = "#{e.doSaveInvoiceDate}"/>

  </x:form-panel>

  <script type = "text/javascript">
  //<![CDATA[

  extjsf.bindHandler("${z:vid(e, 'submit')}", '${rootView.extjsDomain}', function()
  {
    var form = extjsf.bind("${z:vid(e, 'invoice-date-form')}", '${rootView.extjsDomain}');

    //~: set go-back handler on success
    form.success(extjsf.bindHandler("${z:vid(e, 'cancel-edit')}", '${rootView.extjsDomain}'))

    //!: submit
    form.submitForm({'${e.viewModeParam}': '${e.viewModePostStr}', command: 'submit_action'})
  })

  extjsf.bindHandler("${z:vid(e, 'date')}", '${rootView.extjsDomain}', function()
  {
    var form = extjsf.bind("${z:vid(e, 'invoice-date-form')}", '${rootView.extjsDomain}');

    //~: set reload order-close invoices on success
    form.success(function()
    {
      Ext.data.StoreManager.lookup("${z:vid(e, 'dateCloseInvoices')}").load()
    })

    //!: submit
    form.submitForm({'${e.viewModeParam}': '${e.viewModePostStr}'})
  })

  //]]>
  </script>

  <!-- invoice date edit form] -->


  <!-- [invoices order preview panel -->

  <x:data-store storeId = "${z:vid(e, 'dateCloseInvoices')}"
    modelRequest = "edit-date">

    <f:facet name = "store-props">
      model: 'retrade.model.InvoiceView'
    </f:facet>

    <f:facet name = "proxy-props">
      reader: ZeT.defined('retrade.readers.DateCloseInvoices'),
      extraParams : {
        '${e.modelParam}': '${e.model.modelKey}'
      }
    </f:facet>
  </x:data-store>

  <x:data-grid coid = "${z:vid(e, 'date_close_invoices')}"
    storeId = "${z:vid(e, 'dateCloseInvoices')}">

    <f:facet name = "grid-props">

      title: 'Порядок накладных', region: 'center',
      margin: extjsf.pts(1, 1, 1, 1),
      sortableColumns: false, enableColumnHide: false,
      columns: ZeT.defined("retrade.columns.Invoice#{(e.moveInvoice)?('Move'):('')}View")

    </f:facet>

    <script type = "text/javascript">
    //<![CDATA[

  (function()
  {
    var s = extjsf.bind("${z:vid(e, 'dateCloseInvoices')}", '${rootView.extjsDomain}');
    var g = extjsf.bind("${z:vid(e, 'date_close_invoices')}", '${rootView.extjsDomain}');
    var m = Ext.create('Ext.selection.RowModel');
    var x = '#{e.invoice.objectKey}';

    //~: set the selection model to the grid
    g.extjsProps({selModel: m})

    //~: disable selection of else rows
    m.on('beforeselect', function(that, record)
    {
      if(record.getId() == x) return true;
      if(m.retradeSelected) m.select([m.retradeSelected])
      return false;
    })

    //~: select the row of the invoice edited
    s.on('load', function(store)
    {
      if(!m.retradeSelected)
        m.retradeSelected = store.getById(x);
      if(m.retradeSelected) m.select([m.retradeSelected])
    })
  })()

    //]]>
    </script>

  </x:data-grid>

  <!-- invoices order preview panel] -->

</x:winmain>
</ui:define>
</ui:decorate>

<ui:decorate template = '/resources/.view-modes/body_post.xhtml'
   xmlns    = 'http://tverts.com/retrade/webapp/response'
   xmlns:ui = 'http://java.sun.com/jsf/facelets'>

  <ui:define name = 'validation'>

    <validation success = "true" target = "${z:vid(e, 'invoice-date-form')}"/>

  </ui:define>
</ui:decorate>
</ui:component>