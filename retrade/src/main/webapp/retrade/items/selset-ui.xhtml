<?xml version = '1.0' encoding = 'UTF-8'?>

<ui:component xmlns:ui = 'http://java.sun.com/jsf/facelets'
  xmlns:c  = 'http://java.sun.com/jsp/jstl/core'
  xmlns:f  = 'http://java.sun.com/jsf/core'
  xmlns:x  = 'http://java.sun.com/jsf/composite/.xhtml'
  xmlns:z  = 'uri:tverts.com'>

  <c:set var = "v" scope = "request" value = "${facesSelSetView}"/>

  ${v.checkModelRequestedWithRedirect}

  <ui:decorate template = '/resources/.view-modes/body.xhtml'
    xmlns    = 'http://www.w3.org/1999/xhtml'
    xmlns:h  = 'http://java.sun.com/jsf/html'
    xmlns:x  = 'http://java.sun.com/jsf/composite/.xhtml'>

  <ui:define name = 'page_body'>


  <!-- [selection set data store] -->
  <x:data-store storeId = "${z:vid(v, 'selSetStore')}"
    modelView = "${v}">

    <f:facet name = "store-props">
      model: 'retrade.model.SelSetView', autoLoad: false
    </f:facet>

    <f:facet name = "proxy-props">
      reader: ZeT.defined('retrade.readers.SelSetView')
    </f:facet>
  </x:data-store>


  <!-- [script to add object to selection] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_add_object')}"
     action = "#{v.doAddObject}" modelView = "${v}"/>


  <!-- [script to delete object from selection] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_del_object')}"
    action = "#{v.doDelObject}" modelView = "${v}"/>


  <!-- [script to delete item from selection] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_del_item')}"
    action = "#{v.doDelItem}" modelView = "${v}"/>


  <!-- [script to add new selection] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_add')}"
     action = "#{v.doAddSelSet}" modelView = "${v}"/>


  <!-- [script to clear the selection] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_clear')}"
     action = "#{v.doClearSelSet}" modelView = "${v}"/>


  <!-- [script to change selection] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_change')}"
     action = "#{v.doChangeSelSet}" modelView = "${v}"/>


  <!-- [script to delete selection set] -->
  <x:action-call coid = "${z:vid(v, 'script_selset_delete')}"
     action = "#{v.doDeleteSelSet}" modelView = "${v}"/>


  <script type = "text/javascript">
  //<![CDATA[

  //~: post-initialize selection set global instance
  ReTrade.selset.
    model('${v.modelKeys}').
    storeId("${z:vid(v, 'selSetStore')}").
    url('window', "${z:url('/go/retrade/items/selset-win')}").
    buildMenu(#{v.selSetMenuModel})


  //~: selection set add script wrapper
  ReTrade.selset.adder(function(id, remove)
  {
     var script = (remove)?("${z:vid(v, 'script_selset_del_object')}"):("${z:vid(v, 'script_selset_add_object')}");

     extjsf.handler(script, '${extDom}')({
       params: { entity: id }, success: function()
       {
         Ext.data.StoreManager.lookup("${z:vid(v, 'selSetStore')}").loadPage(1)
       }
     })
  })


  //~: selection set change script wrapper
  ReTrade.selset.changer(function(selset, onsuccess)
  {
     extjsf.handler("${z:vid(v, 'script_selset_change')}", '${extDom}')({
       params: { selset: selset }, success: onsuccess
     })
  })


  //~: selection set toggle button
  $('#' + ReTrade.selset.button()).click(function()
  {
    ReTrade.selset.toggle(undefined, retrade_default('selset-win'))
  })


  //~: edit selection
  $('#' + ReTrade.selset.ctlitems('edit')).click(function()
  {
    //~: access active selection set window
    var window = ReTrade.selset.window()

    //?: {has it no} open in edit mode
    if(!window) return ReTrade.selset.toggle(
      true, { params: { 'selset-edit': 'true' }})

    var edit = extjsf.bind("${z:vid(v, 'window-selset-edit')}", '${extDom}')
    var grid = extjsf.bind("${z:vid(v, 'selset-grid')}", '${extDom}')
    ZeT.assert(edit && grid, 'Selection Set window has no content!')

    grid.co().hide()
    edit.co().show()
  })


  //~: add selection
  $('#' + ReTrade.selset.ctlitems('add')).click(function()
  {
    extjsf.handler("${z:vid(v, 'script_selset_add')}", '${extDom}')()
  })


  //~: delete selection set
  $('#' + ReTrade.selset.ctlitems('delete')).click(function()
  {
    extjsf.handler("${z:vid(v, 'script_selset_delete')}", '${extDom}')({
      success: function()
      {
         Ext.data.StoreManager.lookup(ReTrade.selset.storeId()).load()
         ReTrade.selset.reload()
      }
    })
  })


  //~: clear selection
  $('#' + ReTrade.selset.ctlitems('clear')).click(function()
  {
    extjsf.handler("${z:vid(v, 'script_selset_clear')}", '${extDom}')({
      success: function()
      {
        Ext.data.StoreManager.lookup("${z:vid(v, 'selSetStore')}").loadPage(1)
      }
    })
  })


  //!: synchronize on the desktop
  //ReTrade.desktop.readyPoint('ReTrade.selset', true)

 //]]>
 </script>

 </ui:define>
</ui:decorate>

<ui:decorate template = '/resources/.view-modes/body_post.xhtml'
   xmlns    = 'http://extjs.jsf.java.net/response'
   xmlns:ui = 'http://java.sun.com/jsf/facelets'>

  <ui:define name = 'validation'>
    <validation success = "true"/>
  </ui:define>

  <ui:define name = 'scripts'>

    <ui:fragment rendered = "#{v.renderItems}">
      <script>
      //<![CDATA[

ReTrade.selset.items([#{v.selSetItems}])

      //]]>
      </script>
    </ui:fragment>

    <ui:fragment rendered = "#{v.updatedMenu}">
      <script>
      //<![CDATA[

if(ReTrade.selset.window())
  ReTrade.selset.window().co().setTitle('${z:jss(v.windowTitle)}')

ReTrade.selset.buildMenu(#{v.selSetMenuModel})

      //]]>
      </script>
    </ui:fragment>
  </ui:define>
</ui:decorate>
</ui:component>
