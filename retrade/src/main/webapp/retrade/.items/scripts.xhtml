<ui:component xmlns:ui = 'http://java.sun.com/jsf/facelets'
  xmlns:f = 'http://java.sun.com/jsf/core'>

<script type = "text/javascript">
//<![CDATA[

function retrade_go_url(url)
{
  ZeT.asserts(url, 'No load URL is provided!')

  //?: {create relative go-address}
  if(url.indexOf('/go/retrade') == -1)
  {
    if(ZeTS.startsWith(url, '/'))
      url = ZeT.asserts(url.substring(1))
    url = "${z:url('/go/retrade/XYZ')}".replace('XYZ', url)
  }

  return url
}

function retrade_open_window(opts)
{
  ZeT.assertn(opts)

  //?: {has domain key}
  if(opts.domainKey)
  {
    ZeT.asserts(opts.domainKey)
    ZeT.assert(ZeT.isu(opts.domain))

    opts.domain = 'desktop-window:' + opts.domainKey

    if(!ZeT.isu(opts.record)) //?: {has record key}
      opts.domain += ':record:' + opts.record
  }

  //?: {has no domain provided} make the default
  if(!opts.domain)
  {
    if(!opts.tempDomain) opts.domain = 'desktop-window:auto-domain:'
      else opts.domain = 'desktop-window:' + opts.tempDomain

    if(!ZeT.isu(opts.record)) //?: {has record key}
      opts.domain += ':record:' + opts.record + ':'

    if(!opts.domain.endsWith(':')) opts.domain += ':'
    opts.domain = extjsf.tempDomain(opts.domain)
  }

  ZeT.asserts(opts.domain, 'No ExtJSF window domain string is provided!')

  //~: lookup the window bind
  var winmain = extjsf.bind('winmain', opts.domain)

  //?: {has no box provided}
  if(!opts.box) opts.box = { widthpt: 480, heightpt: 360 }
  ZeT.assert(ZeT.iso(opts.box))

  //~: calculate the box
  var box = ReTrade.desktop.calcWindowBox(opts.box)

  if(winmain) //?: {has this window} show it
  {
    winmain.co().toFront()
    winmain.co().setPagePosition(box.x, box.y)
    winmain.co().expand()
    return
  }

  //~: load url
  opts.url = retrade_go_url(opts.url)

  //~: window layout
  if(!opts.layout) opts.layout = 'fit'
  ZeT.asserts(opts.layout)

  //~: parameters
  if(!opts.params) opts.params = {}
  ZeT.assert(ZeT.iso(opts.params))

  //~: domain parameter
  opts.params['${rootView.extjsDomainParam}'] = opts.domain

  //~: view mode parameter (default is body)
  if(!opts.params['${rootView.viewModeParam}'])
    opts.params['${rootView.viewModeParam}'] = 'body'

  //~: record parameter
  if(opts.record) opts.params['${rootView.entityParam}'] = '' + opts.record

  //~: create the window bind
  winmain = extjsf.defineBind('winmain', opts.domain).extjsProps({

    xtype: 'window', title: 'Загрузка...',
    x: box.x, y: box.y, width: box.width, height: box.height,
    layout: opts.layout, autoShow: !opts.hidden,
    collapsible: opts.collapsible,

    loader: { url: opts.url, autoLoad: true, scripts: true,
      ajaxOptions: { method: 'GET' }, params: opts.params
    }
  })

  //?: {has on-close}
  if(ZeT.isf(opts.onclose))
    winmain.on('beforedestroy', ZeT.fbind(opts.onclose, winmain))

  //~: create the ExtJS Window component & return the bind
  winmain.co(Ext.create('Ext.window.Window', winmain.extjsProps()))
  return winmain
}

/**
 * Returns function that sequentially loads a content
 * into the components denoted by the options list.
 */
function retrade_chain_loader(/* [callback], options for each area */)
{
  function load(next)
  {
    var url = this.url, bind = this.bind,
      domain = this.domain, viewMode = this.viewMode

    extjsf.defineBind('onload', domain, function(root)
    {
      bind.co().add(root.co())
      if(ZeT.isf(next)) next()
    })

    Ext.create('Ext.ComponentLoader', {
      target: bind.co(), url: url,
      ajaxOptions: {method: 'GET'}, autoLoad: true,
      scripts: true, params: {
        '${rootView.viewModeParam}': viewMode,
        '${rootView.extjsDomainParam}': domain
    }})
  }

  var prev = null

  //?: {has callback}
  if(ZeT.isf(arguments[0]))
    prev = arguments[0] //<-- will be the last

  //~: build the loads chain
  ZeT.each(arguments, function(opts)
  {
    if(!ZeT.iso(opts)) return

    //?: {not an active item}
    if(opts.active === false || opts.active === 'false') return

    //~: process the load url
    opts.url = retrade_go_url(opts.url)

    //?: {has no bind}
    ZeT.assert(opts.bind && opts.bind.extjsfBind === true)

    //~: select the content domain
    if(opts.domain) ZeT.asserts(opts.domain); else if(opts.tempDomain)
    {
      ZeT.asserts(opts.tempDomain)
      opts.domain = extjsf.tempDomain(opts.tempDomain)
    }

    //?: {has no domain}
    ZeT.asserts(opts.domain)

    //~: view mode
    if(!opts.viewMode) opts.viewMode = 'body'

    //~: add to the loading chain
    prev = ZeT.fbind(load, opts, prev)
  })

  //~: invoke the loads chain
  return function()
  {
    if(prev) prev()
  }
}

function retrade_chain_on_load(domain, rootBind)
{
  ZeT.asserts(domain)

  var onload = extjsf.bind('onload', domain)
  if(!onload) return

  if(ZeT.iss(rootBind))
    rootBind = extjsf.bind(rootBind, domain)
  ZeT.assert(rootBind && rootBind.extjsfBind === true)

  onload(rootBind)
}

function retrade_replicate_store(master, slave, domain)
{
  if(ZeT.iss(master))
    master = extjsf.bind(master, domain)
  master = extjsf.asbind(master)
  ZeT.assert(master)

  if(ZeT.iss(slave))
    slave = extjsf.bind(slave, domain)
  slave = extjsf.asbind(slave)
  ZeT.assert(slave)

  function synch_data()
  {
    var rs = []; master.co().each(
      function(m){ rs.push(m.copy()) })

    slave.co().removeAll()
    slave.co().add(rs)
  }

  if(master.co() && slave.co() && master.co().isLoaded())
    synch_data()

  //~: record inserted-removed
  master.on('datachanged', synch_data)

  //~: record changed
  master.on('update', function(s, m, op, fs)
  {
    ZeT.assertn(m.getId())
    var x = ZeT.assertn(slave.co().getById(m.getId()),
      'Record ID [', m.getId(), '] is not found in the slave Store!')

    //~: assign the updated fields
    ZeT.each(fs, function(f){ x.set(f, m.get(f)) })
  })
}

//]]>
</script>
</ui:component>