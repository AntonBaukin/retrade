<?xml version = '1.0' encoding = 'UTF-8'?>

<ui:component xmlns:ui = 'http://java.sun.com/jsf/facelets'
  xmlns:c  = 'http://java.sun.com/jsp/jstl/core'
  xmlns:f  = 'http://java.sun.com/jsf/core'
  xmlns:z  = 'uri:extjs.jsf.java.net'>

<c:set var = "v" scope = "request" value = "${facesGoodsView}"/>

${rootView.forceSecure('view: goods')}
${v.checkModelRequestedWithRedirect}

<ui:decorate template = '/resources/.view-modes/body.xhtml'
   xmlns    = 'http://www.w3.org/1999/xhtml'
   xmlns:h  = 'http://java.sun.com/jsf/html'
   xmlns:x  = 'http://java.sun.com/jsf/composite/.xhtml'>

  <ui:define name = 'page-body'>

  <x:desktop-panel coid = "${z:vid(v, 'documents-root')}"
    position = "#{rootView.extjsPosition}">

    <f:facet name = "extjs-props">
      title: 'Товары и услуги', layout: 'fit'
    </f:facet>

    <!-- [toolbar -->

    <f:facet name = "toolbar-props">
      xtype: 'panel', bodyPadding: extjsf.pts(0, 2, 0, 2),
      layout: {type: 'hbox', align: 'middle'},
      bodyCls: 'retrade-toolbar-inline-panel'
    </f:facet>

    <f:facet name = "toolbar">

      <ui:decorate template = '.list-toolbar.xhtml'
        xmlns = 'http://www.w3.org/1999/xhtml'>

        <ui:param name = "toggleTableView" value = "retrade-tree-list"/>

      </ui:decorate>
    </f:facet>

    <ui:decorate template = '.list-grid.xhtml'
        xmlns = 'http://www.w3.org/1999/xhtml'>

      <ui:param name = "pageSize" value = "20"/>
      <ui:param name = "columnModel" value = "GoodUnitViewShort"/>

    </ui:decorate>

    <script type = "text/javascript">
    //<![CDATA[

    //~: insert selected folders in the top
    extjsf.bind("${z:vid(v, 'goodUnits')}", '${extDom}').on('load', function(store, recs)
    {
      //~: selected folder node
      var t = extjsf.co("${z:vid(v, 'tree')}", '${extDom}')
      var f = t.getSelection(); if(!f || f.length != 1) return; else f = f[0]
      if(f.get('objectKey') == '$') return

      var ms = [], p = f
      function addItem()
      {
        ms.unshift(Ext.create('retrade.model.GoodUnitView', {
          objectKey: 'folder$'+ p.get('objectKey'),
          goodCode: p.get('code'), goodName: p.get('name'),
          uiRowClass: ZeTS.cat('retrade-goods-grid-row-', (f == p)?('selected'):('parent'))
        }))
      }

      //~: trace up to the root
      while(true)
      {
        //~: create model item
        addItem()

        //?: {has no parent node}
        if(ZeT.isu(p = p.get('parentKey')))
        {
          p = t.getStore().getRoot()
          addItem()
          break
        }

        //~: go up
        p = ZeT.assertn(t.getStore().getAt(t.getStore().find('objectKey', p)))
      }

      //~: has the children
      ZeT.each(f.get('children'), function(c)
      {
        ms.push(Ext.create('retrade.model.GoodUnitView', {
          objectKey: 'folder$'+ c.objectKey, goodCode: c.code, goodName: c.name,
          parentFolder : f, uiRowClass: 'retrade-goods-grid-row-child'
        }))
      })

      //~: insert the models
      store.insert(0, ms)
    })

    //~: set special formatter of the grid rows
    extjsf.bind("${z:vid(v, 'grid')}", '${extDom}').getRowClass = function(record)
    {
      return record.get('uiRowClass')
    }

    //~: grid double click -> open good if not a folder
    extjsf.bind("${z:vid(v, 'add-good')}", '${extDom}').retradeOpenGoodWindow2 =
      extjsf.bind("${z:vid(v, 'add-good')}", '${extDom}').retradeOpenGoodWindow
    extjsf.bind("${z:vid(v, 'add-good')}", '${extDom}').retradeOpenGoodWindow  =
      function(record, e, opts)
    {
      var f = record && record.get('objectKey')
      if(!f || (f.indexOf('folder$') != 0))
        return extjsf.bind("${z:vid(v, 'add-good')}", '${extDom}').
          retradeOpenGoodWindow2(record, e, opts)
    }

    //~: grid click -> open folder
    extjsf.bind("${z:vid(v, 'grid')}", '${extDom}').
      on('itemclick', function(grid, record)
      {
        var f = record.get('objectKey'); if(f.indexOf('folder$') != 0) return
        var k = f.substring('folder$'.length)

        //~: find the folder in the tree
        var t = extjsf.co("${z:vid(v, 'tree')}", '${extDom}')
        f = t.getStore().query('objectKey', k)
        if(f && (f.getCount() == 1))
          return t.getSelectionModel().select([ f.getAt(0) ])

        //~: expand the parent node
        record.get('parentFolder').expand()
        f = t.getStore().query('objectKey', k)
        ZeT.assert(f && (f.getCount() == 1))
        t.getSelectionModel().select([ f.getAt(0) ])
      })

    //]]>
    </script>
  </x:desktop-panel>
</ui:define>
</ui:decorate>

<ui:decorate template = '/resources/.view-modes/body_post.xhtml'
   xmlns    = 'http://extjs.jsf.java.net/response'
   xmlns:ui = 'http://java.sun.com/jsf/facelets'>

  <ui:define name = 'validation'>
    <validation success = "true"/>
  </ui:define>
</ui:decorate>
</ui:component>