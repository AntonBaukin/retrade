<?xml version = '1.0' encoding = 'UTF-8'?>

<ui:component xmlns:ui = 'http://java.sun.com/jsf/facelets'
  xmlns:c  = 'http://java.sun.com/jsp/jstl/core'
  xmlns:f  = 'http://java.sun.com/jsf/core'
  xmlns:z  = 'uri:tverts.com'>

<c:set var = "v" scope = "request" value = "${facesClientGoodsView}"/>

${rootView.forceSecureClientOnly(true)}
${v.checkModelRequestedWithRedirect}

<ui:decorate template = '/resources/.view-modes/body.xhtml'
   xmlns    = 'http://www.w3.org/1999/xhtml'
   xmlns:h  = 'http://java.sun.com/jsf/html'
   xmlns:x  = 'http://java.sun.com/jsf/composite/.xhtml'>

  <ui:define name = 'page_body'>

  <x:root-panel coid = "${z:vid(v, 'goods_root_panel')}" position = "#{rootView.extjsPosition}">

    <f:facet name = "extjs-props">
      title: 'Цены товаров'
    </f:facet>


    <!-- [toolbar -->

    <f:facet name = "toolbar-props">
      xtype: 'panel', bodyPadding: extjsf.pt(2),
      layout: {type: 'hbox', align: 'middle'},
      bodyCls: 'retrade-toolbar-inline-panel'
    </f:facet>

    <f:facet name = "toolbar">

      <x:component coid = "${z:vid(v, '_tb_fill_0')}">
        <f:facet name = "extjs-props">
          xtype: 'panel', flex: 1, frame: false, border: false,
          bodyCls: 'retrade-toolbar-inline-panel'
        </f:facet>
      </x:component>


      <!-- [filter goods field -->

      <x:text-field coid = "${z:vid(v, 'search-goods')}"
        value = "#{v.model.searchGoods}">

        <f:facet name = "extjs-props">
          margin: extjsf.dpts(1, 0, 1, 4),
          width:  extjsf.ex(24)
        </f:facet>

        <f:facet name = "label-props">
          text: 'Поиск', margin: extjsf.pts(1, 0, 1, 8)
        </f:facet>
      </x:text-field>


      <!-- [restrict to selection set] -->

      <x:component coid = "${z:vid(v, 'search-goods-selset')}">
        <f:facet name = "extjs-props">

          xtype: 'button', enableToggle: true,
          width: 30, componentCls: 'retrade-icon-24',
          margin: extjsf.dpts(1, 0, 1, 6),
          iconCls: 'retrade-selset-button-icon',
          tooltipType: 'title', tooltip: 'Ограничить текущей выборкой'

        </f:facet>
      </x:component>


      <x:action-call coid = "${z:vid(v, 'search-goods-script')}"
        action = "#{v.doSearchGoods}">

        <f:facet name = "action-params">
          '${v.modelParam}': '${v.modelKeys}'
        </f:facet>
      </x:action-call>

      <script type = "text/javascript">
      //<![CDATA[

    extjsf.bind("${z:vid(v, 'search-goods')}", '${rootView.extjsDomain}').on('change', function(f)
    {
      var sv = ZeTS.trim(f.getValue());
      if(!f.extjsfBind) return; f.extjsfBind.searchValue = sv;

      var fn = function()
      {
        //?: {search string was changed} discard
        if(f.extjsfBind.searchValue != sv) return;

        var params = { searchGoods: sv };
        var selchk = extjsf.bind("${z:vid(v, 'search-goods-selset')}", '${rootView.extjsDomain}').component();
        if(selchk.pressed) params.selset = ReTrade.selset.selset;

        extjsf.bindHandler("${z:vid(v, 'search-goods-script')}", '${rootView.extjsDomain}')({
          params: params, success : function() {
            Ext.data.StoreManager.lookup("${z:vid(v, 'goodUnits')}").loadPage(1)
        }})
      }

      setTimeout(fn, 1000)
    })

    //~: selection set only toggled
    extjsf.bind("${z:vid(v, 'search-goods-selset')}", '${rootView.extjsDomain}').on('toggle', function()
    {
        var names  = extjsf.bind("${z:vid(v, 'search-goods')}", '${rootView.extjsDomain}').value();
        var params = { searchGoods: names };

        var selchk = extjsf.bind("${z:vid(v, 'search-goods-selset')}", '${rootView.extjsDomain}').component();
        if(selchk.pressed) params.selset = ReTrade.selset.selset;

        extjsf.bindHandler("${z:vid(v, 'search-goods-script')}", '${rootView.extjsDomain}')({
          params: params, success : function() {
             Ext.data.StoreManager.lookup("${z:vid(v, 'goodUnits')}").loadPage(1)
        }})
    })

      //]]>
      </script>

      <!-- filter goods field] -->

    </f:facet>

    <!-- toolbar] -->


    <!-- [goods table -->

    <x:data-store storeId = "${z:vid(v, 'goodUnits')}"
      modelView = "${v}" pageSize = "20">

      <f:facet name = "store-props">
        model: 'retrade.model.GoodPriceView', remoteSort: true,
        sorters: [{ property: 'goodName', direction: 'ASC' }]
      </f:facet>

      <f:facet name = "proxy-props">
        reader: ZeT.defined('retrade.readers.GoodUnitView')
      </f:facet>
    </x:data-store>

    <x:data-grid coid = "${z:vid(v, 'grid')}" selset = "true"
      storeId = "${z:vid(v, 'goodUnits')}">

      <f:facet name = "grid-props">

        columns: ZeT.defined('retrade.columns.ClientGoodPriceView'),
        selModel: extjsf.delayCreate('Ext.selection.RowModel', {mode: 'SINGLE'}),
        pager: true, sortableColumns: true, region: 'center',
        cls: 'retrade-grid-large'

      </f:facet>
    </x:data-grid>

    <!-- goods table] -->


    <!-- [good info window -->

    <x:component coid = "${z:vid(v, 'goods-info-window')}">
      <f:facet name = "extjs-props">

        xtype: 'window', closeAction: 'hide', layout: 'fit',
        resizable: false, header: false, draggable: false,
        border: false, bodyCls: 'retrade-transparent-panel',
        bodyPadding: extjsf.pt(2)

      </f:facet>

      <x:html coid = "${z:vid(v, 'goods-info-html')}">

        <table id = "${z:vid(v, 'goods-info')}"
          cellpadding = "0" cellspacing = "0" border = "0"
          class = "retrade-client-good-layout"
          style="width: 100%; height: 100%;">

          <tr><td style = "vertical-align: top;">
          <table cellpadding = "0" cellspacing = "0" border = "0"
                 class = "retrade-info-table retrade-client-good-main">
            <tr>
              <td class = "retrade-info-title retrade-client-good-info-code">
                <div>Код товара</div>
              </td>
              <td class = "retrade-info-value retrade-client-good-info-code">
                <div/>
              </td>

              <td class = "retrade-client-good-info-code-price-sep" style = "width:100%; min-width: 7pt;"><div/></td>

              <td class = "retrade-info-title retrade-client-good-info-price">
                <div style="margin-left: 0;">Цена</div>
              </td>
              <td class = "retrade-info-value retrade-client-good-info-price">
                <div/>
              </td>
              <td class = "retrade-info-value retrade-client-good-info-price-mucode">
                <div style="margin-left: 2px;"/>
              </td>
            </tr>
            <tr>
              <td colspan = "6" class = "retrade-info-value retrade-client-good-info-name">
                <div style = "margin-top: 2px;"/>
              </td>
            </tr>
          </table>

          <table cellpadding = "0" cellspacing = "0" border = "0"
                 class = "retrade-info-table retrade-client-good-measure" style="margin-top: 2px;">
            <tr>
              <td class = "retrade-info-title retrade-client-good-info-measure">
                <div>Ед. изм.</div>
              </td>
              <td class = "retrade-info-value retrade-client-good-info-mucode">
                <div style="margin-left: 2px;"/>
              </td>
              <td class = "retrade-info-value retrade-client-good-info-muname" style="width:100%;">
                <div style="margin-left: 2px;"/>
              </td>
            </tr>
          </table>
        </td></tr>

        <style type="text/css">

          tr.retrade-client-good-loaded-layout > td
          {
            vertical-align: top;
          }

          tr.retrade-client-good-loaded-layout.retrade-client-good-loaded-layout-loading > td
          {
            vertical-align: middle;
          }

        </style>


        <tr class = "retrade-client-good-loaded-layout"><td style="width: 100%; height: 100%; text-align: center;">

          <!-- is now loading message -->
          <span class = "retrade-client-good-loading" style = "display: none; font-style: italic;">
            Загрузка...
          </span>

          <!-- loadded content layout-->
          <table cellpadding = "0" cellspacing = "0" border = "0"
            class = "retrade-client-good-loaded-content" style = "display: none; width: 100%;">

            <!-- row for a regular good -->
            <tr class = "retrade-client-good-is-regular" style="display: none;">
              <td class = "retrade-info-value-small-text" style="text-transform: uppercase; font-weight: bolder; padding-top: 8px;">
               <div style="text-align: right; cursor: default;">Товар или сырьё</div>
              </td>
            </tr>

            <!-- derived good -->
            <tr class = "retrade-client-good-is-derived" style="display:none"><td>

              <table cellpadding = "0" cellspacing = "0" border = "0" style = "width: 100%; margin-top: 2px;">
                <tr>
                  <td class = "retrade-info-title retrade-client-good-info-super-code">
                    <div>Базовый товар</div>
                  </td>
                  <td class = "retrade-info-value retrade-client-good-info-super-code">
                    <div/>
                  </td>

                  <td class = "retrade-client-good-info-super-code-volume-sep" style = "width:100%; min-width: 7pt;"><div/></td>

                  <td class = "retrade-info-title retrade-client-good-info-super-volume">
                    <div style="margin-left: 0;">Объём</div>
                  </td>
                  <td class = "retrade-info-value retrade-client-good-info-super-volume">
                    <div/>
                  </td>
                  <td class = "retrade-info-value retrade-client-good-info-super-volume-mucode">
                    <div style="margin-left: 2px;"/>
                  </td>
                </tr>
                <tr>
                  <td colspan = "6" class = "retrade-info-value retrade-client-good-info-super-name">
                    <div style = "margin-top: 2px;"/>
                  </td>
                </tr>
              </table>

              <table cellpadding = "0" cellspacing = "0" border = "0" style = "width: 100%; margin-top: 2px;">
                <tr>
                  <td class = "retrade-info-value-small-text retrade-client-good-is-derived-semi-ready" style="text-transform: uppercase; font-weight: bolder; padding-top: 8px; cursor: default;">
                    <div style="text-align: right;">Полуфабрикат</div>
                  </td>

                  <td style="width:100%;"><div/></td>

                  <td class = "retrade-info-value-small-text" style="text-transform: uppercase; font-weight: bolder; padding-top: 8px; cursor: default;">
                    <div style="text-align: right;">Производный продукт</div>
                  </td>
                </tr>
              </table>
            </td></tr>

            <!-- regular product -->
            <tr class = "retrade-client-good-is-product" style="display: none; width: 100%;"><td>

              <div class = "retrade-info-title-label retrade-client-good-product-top"
                style = "text-align: left; padding: 2px 0 2px 0">
                Ингредиенты (состав):
              </div>

              <div class = "retrade-client-good-product-table" style = "overflow: auto;">
              <table cellpadding = "0" cellspacing = "0" border = "0" style = "width: 100%;">
                <tr class = "retrade-client-good-product-part-template" style = "display:none">
                  <td class = "retrade-info-value retrade-client-good-product-part-volume"
                      style = "padding-top: 2px;">
                    <div style="text-align: right;"/>
                  </td>
                  <td class = "retrade-info-value retrade-client-good-product-part-mucode"
                      style = "padding: 2px 0 0 2px">
                    <div/>
                  </td>
                  <td class = "retrade-info-value retrade-client-good-product-part-code"
                      style = "padding: 2px 0 0 2px">
                    <div/>
                  </td>
                  <td class = "retrade-info-value retrade-client-good-product-part-name"
                      style = "padding: 2px 0 0 2px">
                    <div/>
                  </td>
                </tr>
              </table>
              </div>

              <table class = "retrade-client-good-product-bottom"
                cellpadding = "0" cellspacing = "0" border = "0" style = "width: 100%;">
                <tr>
                  <td class = "retrade-info-value-small-text retrade-client-good-is-product-semi-ready" style="text-transform: uppercase; font-weight: bolder; padding-top: 8px; cursor: default;">
                    <div style="text-align: right;">Полуфабрикат</div>
                  </td>

                  <td style="width:100%;"><div/></td>

                  <td class = "retrade-info-value-small-text" style="text-transform: uppercase; font-weight: bolder; padding-top: 8px; cursor: default;">
                    <div style="text-align: right;">Продукт</div>
                  </td>
                </tr>
              </table>
            </td></tr>
          </table>

        </td></tr>
        </table>
      </x:html>
    </x:component>

    <x:action-call coid = "${z:vid(v, 'goods-info-script')}"
      action = "#{v.doViewGoodInfo}">

      <f:facet name = "action-params">
        '${v.modelParam}': '${v.modelKeys}'
      </f:facet>
    </x:action-call>

    <script type = "text/javascript">
    //<![CDATA[

  extjsf.bind("${z:vid(v, 'grid')}", '${rootView.extjsDomain}').
    on('cellclick', function(grid, td, cellIndex, record, tr, rowIndex, e)
  {
    //?: {this is action column}
    var column = extjsf.support.gridColumns(grid, true)[cellIndex];
    if('actioncolumn' === column.xtype) return

    //~: calculate the box
    var box = ReTrade.desktop.calcWindowBox({
      event: e, widthpt: 260, heightpt: 180, '+xpt': -130, '-y': 90
    })

    //~: the info window
    var wnd = extjsf.component("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}');

    //~: request the info
    extjsf.bindHandler("${z:vid(v, 'goods-info-script')}", '${rootView.extjsDomain}')({
      params: { goodUnit: record.getId() }
    })

    //~: close listener
    if(!wnd.extjsfBind.retradeWindowShow)
      wnd.on('show', wnd.extjsfBind.retradeWindowShow = function()
      {
        ZeT.timeout(100, function()
        {
          //~: listen on body
          var clo; Ext.getBody().on('click', clo = function(e)
          {
            //?: {is click in the window}
            if(!wnd.getRegion().isOutOfBound(Ext.util.Point.fromEvent(e))) return

            //!: destroy the listener
            Ext.getBody().removeListener('click', clo)

            wnd.close() //<-- hide the window
          })
        })
      })

    //~: init the fields
    var init = function()
    {
      var n = Ext.get("${z:vid(v, 'goods-info')}");

      //=: good code
      n.down('td.retrade-info-value.retrade-client-good-info-code div').
        update(record.get('goodCode'))

      //=: good price
      n.down('td.retrade-info-value.retrade-client-good-info-price div').
        update(record.get('price'))

      //=: measure unit code (at the price)
      n.down('td.retrade-info-value.retrade-client-good-info-price-mucode div').
        update(record.get('measureCode'))

      //=: good name
      n.down('td.retrade-info-value.retrade-client-good-info-name div').
        update(record.get('goodName'))

      //=: measure unit code
      n.down('td.retrade-info-value.retrade-client-good-info-mucode div').
        update(record.get('measureCode'))

      //=: measure unit name
      n.down('td.retrade-info-value.retrade-client-good-info-muname div').
        update(record.get('measureName'))

      //~: hide the content pane & show loading message
      var ltr = n.down('tr.retrade-client-good-loaded-layout');
      ltr.addCls('retrade-client-good-loaded-layout-loading')
      ltr.down('table.retrade-client-good-loaded-content').setDisplayed(false)
      ltr.down('span.retrade-client-good-loading').setDisplayed(true)
    }

    //~: show window in the box
    ZeT.timeout(100, function()
    {
      init()
      wnd.show().setBox(box)
    })
  })

  /**
   *  x.irg  {this is a regular good}
   *  x.isr  {this is a semi-ready product}
   *  x.idg  {this is a derived good}
   *  x.ipr  {this is a regular product}
   */
  extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').retardeInitInfoGood = function(x)
  {
    var wnd = extjsf.component("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}');
    var inf = Ext.get("${z:vid(v, 'goods-info')}");
    var ltr = inf.down('tr.retrade-client-good-loaded-layout');
    var ltd = ltr.down('td');
    var cnt = ltd.down('table.retrade-client-good-loaded-content');

    //~: hide loading message & show the content pane
    ltr.removeCls('retrade-client-good-loaded-layout-loading')
    inf.down('span.retrade-client-good-loading').setDisplayed(false)
    cnt.setDisplayed(true)

    //~: hide-display the content areas
    cnt.down('tr.retrade-client-good-is-regular').setDisplayed(!!x.irg)
    cnt.down('tr.retrade-client-good-is-derived').setDisplayed(!!x.idg)
    cnt.down('td.retrade-client-good-is-derived-semi-ready').setDisplayed(!!x.isr)
    cnt.down('tr.retrade-client-good-is-product').setDisplayed(!!x.ipr)
    cnt.down('td.retrade-client-good-is-product-semi-ready').setDisplayed(!!x.isr)

    //?: {is a derived good}
    if(x.idg)
    {
      cnt.down('td.retrade-info-value.retrade-client-good-info-super-code div').update(x.sgc)
      cnt.down('td.retrade-info-value.retrade-client-good-info-super-volume div').update(x.sgv)
      cnt.down('td.retrade-info-value.retrade-client-good-info-super-volume-mucode div').update(x.sgm)
      cnt.down('td.retrade-info-value.retrade-client-good-info-super-name div').update(x.sgn)
    }

    //?: {is a product}
    if(x.ipr)
    {
      var tmp = cnt.down('tr.retrade-client-good-product-part-template', true);
      //var tbl = tmp.parent();

      //~: clear the table
      cnt.select('tr.retrade-client-good-product-part-item').remove()

      //c: for each part
      for(var i = 0;(i < x.pts.length);i++)
      {
        //~: the part
        var p = x.pts[i];

        //~: clone the template & add it
        var n = Ext.get(tmp.cloneNode(true));

        //~: assign item class
        n.removeCls('retrade-client-good-product-part-template')
        n.addCls('retrade-client-good-product-part-item')

        //~: assign the content
        n.down('td.retrade-client-good-product-part-volume div').update(p.volume)
        n.down('td.retrade-client-good-product-part-mucode div').update(p.mucode)
        n.down('td.retrade-client-good-product-part-mucode div').update(p.mucode)
        n.down('td.retrade-client-good-product-part-code div').update(p.code)
        n.down('td.retrade-client-good-product-part-name div').update(p.name)

        //~: display the item
        n.setDisplayed(true)
        tmp.parentNode.appendChild(n.dom)
      }

      //~: release the table height
      ltd.down('div.retrade-client-good-product-table').setStyle({height: 'auto'})
    }

    //~: accommodate the window height
    var dy = wnd.body.getHeight() - (cnt.getTop() - wnd.body.getTop()) - cnt.getHeight();
    if(dy > 0) wnd.setHeight(wnd.getHeight() - dy)

    //?: {is a product with long table}
    if(x.ipr & (dy < 0))
    {
      var tbl = ltd.down('div.retrade-client-good-product-table');
      var top = ltd.down('div.retrade-client-good-product-top');
      var bot = ltd.down('table.retrade-client-good-product-bottom');

      var thh = wnd.body.getHeight() - (cnt.getTop() - wnd.body.getTop()) -
        top.getHeight() - bot.getHeight();

      if(thh > 0) tbl.setHeight(thh)
    }
  }

    //]]>
    </script>

    <!-- good info window] -->

  </x:root-panel>

</ui:define>
</ui:decorate>

<ui:decorate template = '/resources/.view-modes/body_post.xhtml'
   xmlns    = 'http://tverts.com/retrade/webapp/response'
   xmlns:ui = 'http://java.sun.com/jsf/facelets'>

  <ui:define name = 'validation'>
    <validation success = "true"/>
  </ui:define>

  <ui:define name = 'scripts'>

    <ui:fragment rendered = "#{not empty v.infoGood and empty v.infoGood.goodCalc}">
      <script>
      //<![CDATA[

      extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').
        retardeInitInfoGood({ irg: true })

      //]]>
      </script>
    </ui:fragment>

    <ui:fragment rendered = "#{not empty v.infoGood and not empty v.infoGood.goodCalc and not empty v.infoGood.goodCalc.superGood}">
      <script>
      //<![CDATA[

      extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').
        retardeInitInfoGood({ idg: true,
          isr: ('true' == '#{v.infoGood.goodCalc.semiReady}'),
          sgc: '#{z:jss(v.infoGood.goodCalc.superGood.code)}',
          sgn: '#{z:jss(v.infoGood.goodCalc.superGood.name)}',
          sgv: '#{z:jss(v.infoGood.goodCalc.ox.subVolume)}',
          sgm: '#{z:jss(v.infoGood.goodCalc.superGood.measure.code)}'
        })

      //]]>
      </script>
    </ui:fragment>

    <ui:fragment rendered = "#{not empty v.infoGood and not empty v.infoGood.goodCalc and empty v.infoGood.goodCalc.superGood}">

      <script>
        extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').retardeInitInfoGood.ITEMS = [];
      </script>

      <ui:repeat var = "p" value = "#{v.infoGood.goodCalc.parts}">
        <script>
        //<![CDATA[

        extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').retardeInitInfoGood.ITEMS.push({
          volume: '#{z:trim(p.volume)}', code: '#{z:jss(p.goodUnit.code)}',
          name: '#{z:jss(p.goodUnit.name)}', mucode: '#{z:jss(p.goodUnit.measure.code)}'
        })

        //]]>
      </script>
      </ui:repeat>

      <script>
      //<![CDATA[

      extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').
        retardeInitInfoGood({ ipr: true,
          isr: ('true' == '#{v.infoGood.goodCalc.semiReady}'),
          pts: extjsf.bind("${z:vid(v, 'goods-info-window')}", '${rootView.extjsDomain}').retardeInitInfoGood.ITEMS
        })

      //]]>
      </script>
    </ui:fragment>

  </ui:define>
</ui:decorate>
</ui:component>